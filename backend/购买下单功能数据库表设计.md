# 用户购买下单功能 - 数据库表设计

## 1. 概述

本文档描述了用户购买下单功能模块所需的数据库表结构设计,包括产品套餐、订单、用户订阅、支付日志、用户余额等相关表。

## 2. 数据库表结构

### 2.1 products 表 (产品套餐表)

存储系统提供的产品套餐信息。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 产品ID,主键,自增 |
| name | VARCHAR(100) | NOT NULL | 产品名称 |
| description | TEXT | NULL | 产品描述 |
| price | DECIMAL(10,2) | NOT NULL | 产品价格(元) |
| original_price | DECIMAL(10,2) | NULL | 原价(用于折扣展示) |
| duration_days | INT | NOT NULL | 有效期(天数) |
| max_domains | INT | NOT NULL | 最大域名数量 |
| max_subdomains | INT | NOT NULL | 最大二级域名数量 |
| features | JSON | NULL | 功能特性(JSON格式) |
| is_active | TINYINT(1) | DEFAULT 1 | 是否启用(0:禁用, 1:启用) |
| sort_order | INT | DEFAULT 0 | 排序顺序 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- idx_name: name
- idx_is_active: is_active
- idx_sort_order: sort_order

---

### 2.2 orders 表 (订单表)

存储用户订单信息。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 订单ID,主键,自增 |
| order_no | VARCHAR(50) | NOT NULL, UNIQUE | 订单号 |
| user_id | BIGINT UNSIGNED | NOT NULL | 用户ID |
| product_id | BIGINT UNSIGNED | NOT NULL | 产品ID |
| product_name | VARCHAR(100) | NOT NULL | 产品名称(快照) |
| price | DECIMAL(10,2) | NOT NULL | 订单金额 |
| discount_amount | DECIMAL(10,2) | DEFAULT 0.00 | 优惠金额 |
| final_amount | DECIMAL(10,2) | NOT NULL | 实付金额 |
| status | ENUM('pending', 'paid', 'cancelled', 'expired', 'refunded') | DEFAULT 'pending' | 订单状态 |
| payment_method | VARCHAR(50) | NULL | 支付方式(alipay, wechat, balance, epay) |
| payment_time | TIMESTAMP | NULL | 支付时间 |
| paid_at | DATETIME | NULL | 支付完成时间 |
| transaction_id | VARCHAR(100) | NULL | 第三方支付交易号 |
| expires_at | DATETIME | NOT NULL | 订单过期时间 |
| remark | TEXT | NULL | 订单备注 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- idx_order_no: order_no (UNIQUE)
- idx_user_id: user_id
- idx_status: status
- idx_payment_time: payment_time
- idx_expires_at: expires_at

**外键**:
- orders.user_id → users.id
- orders.product_id → products.id

---

### 2.3 user_subscriptions 表 (用户订阅表)

存储用户套餐订阅信息。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 订阅ID,主键,自增 |
| user_id | BIGINT UNSIGNED | NOT NULL, UNIQUE | 用户ID |
| product_id | BIGINT UNSIGNED | NOT NULL | 产品ID |
| product_name | VARCHAR(100) | NOT NULL | 产品名称(快照) |
| start_date | DATETIME | NOT NULL | 订阅开始时间 |
| end_date | DATETIME | NOT NULL | 订阅结束时间 |
| max_domains | INT | NOT NULL | 最大域名数量 |
| max_subdomains | INT | NOT NULL | 最大二级域名数量 |
| used_domains | INT | DEFAULT 0 | 已使用域名数量 |
| used_subdomains | INT | DEFAULT 0 | 已使用二级域名数量 |
| features | JSON | NULL | 功能特性(JSON格式) |
| is_active | TINYINT(1) | DEFAULT 1 | 是否激活 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- idx_user_id: user_id (UNIQUE)
- idx_product_id: product_id
- idx_end_date: end_date
- idx_is_active: is_active

**外键**:
- user_subscriptions.user_id → users.id
- user_subscriptions.product_id → products.id

---

### 2.4 payment_logs 表 (支付日志表)

记录支付相关日志信息。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 日志ID,主键,自增 |
| order_id | BIGINT UNSIGNED | NOT NULL | 订单ID |
| order_no | VARCHAR(50) | NOT NULL | 订单号 |
| payment_method | VARCHAR(50) | NOT NULL | 支付方式 |
| transaction_id | VARCHAR(100) | NULL | 第三方交易号 |
| amount | DECIMAL(10,2) | NOT NULL | 支付金额 |
| status | ENUM('pending', 'success', 'failed', 'refunded') | NOT NULL | 支付状态 |
| request_data | JSON | NULL | 请求数据 |
| response_data | JSON | NULL | 响应数据 |
| error_message | TEXT | NULL | 错误信息 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- idx_order_id: order_id
- idx_order_no: order_no
- idx_transaction_id: transaction_id
- idx_status: status
- idx_created_at: created_at

**外键**:
- payment_logs.order_id → orders.id

---

### 2.5 user_balance 表 (用户余额表)

存储用户余额信息。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 主键ID,主键,自增 |
| user_id | BIGINT UNSIGNED | NOT NULL, UNIQUE | 用户ID |
| balance | DECIMAL(10,2) | DEFAULT 0.00 | 当前余额 |
| total_recharge | DECIMAL(10,2) | DEFAULT 0.00 | 总充值金额 |
| total_consumed | DECIMAL(10,2) | DEFAULT 0.00 | 总消费金额 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- idx_user_id: user_id (UNIQUE)

**外键**:
- user_balance.user_id → users.id

---

### 2.6 balance_transactions 表 (余额交易记录表)

记录用户余额变动流水。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 交易ID,主键,自增 |
| user_id | BIGINT UNSIGNED | NOT NULL | 用户ID |
| type | ENUM('recharge', 'consume', 'refund', 'withdraw', 'system') | NOT NULL | 交易类型 |
| amount | DECIMAL(10,2) | NOT NULL | 交易金额(正数表示增加,负数表示减少) |
| balance_before | DECIMAL(10,2) | NOT NULL | 交易前余额 |
| balance_after | DECIMAL(10,2) | NOT NULL | 交易后余额 |
| description | VARCHAR(255) | NULL | 交易描述 |
| related_order_id | BIGINT UNSIGNED | NULL | 关联订单ID |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- idx_user_id: user_id
- idx_type: type
- idx_related_order_id: related_order_id
- idx_created_at: created_at

**外键**:
- balance_transactions.user_id → users.id
- balance_transactions.related_order_id → orders.id

---

### 2.7 domain_orders 表 (域名购买订单表)

存储用户购买域名使用权的订单信息。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 订单ID,主键,自增 |
| order_no | VARCHAR(50) | NOT NULL, UNIQUE | 订单号 |
| user_id | BIGINT UNSIGNED | NOT NULL | 用户ID |
| domain_id | BIGINT UNSIGNED | NOT NULL | 域名ID |
| domain_name | VARCHAR(255) | NOT NULL | 域名(快照) |
| subdomain | VARCHAR(100) | NULL | 二级域名(快照) |
| price | DECIMAL(10,2) | NOT NULL | 域名价格 |
| duration_days | INT | NOT NULL | 有效期(天数) |
| status | ENUM('pending', 'paid', 'cancelled', 'expired', 'refunded') | DEFAULT 'pending' | 订单状态 |
| payment_method | VARCHAR(50) | NULL | 支付方式(alipay, wechat, balance, epay) |
| payment_time | TIMESTAMP | NULL | 支付时间 |
| paid_at | DATETIME | NULL | 支付完成时间 |
| transaction_id | VARCHAR(100) | NULL | 第三方支付交易号 |
| expires_at | DATETIME | NOT NULL | 订单过期时间 |
| remark | TEXT | NULL | 订单备注 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- idx_order_no: order_no (UNIQUE)
- idx_user_id: user_id
- idx_status: status
- idx_payment_time: payment_time
- idx_expires_at: expires_at

**外键**:
- domain_orders.user_id → users.id
- domain_orders.domain_id → domains.id

---

## 3. 表关系说明

### 3.1 表关系图

```
users (用户表)
  ├── 1:N orders (订单表)
  ├── 1:N domain_orders (域名订单表)
  ├── 1:N user_subscriptions (用户订阅表)
  ├── 1:1 user_balance (用户余额表)
  ├── 1:N balance_transactions (余额交易记录表)
  └── 1:N payment_logs (通过订单关联)

products (产品套餐表)
  ├── 1:N orders (订单表)
  └── 1:N user_subscriptions (用户订阅表)

orders (订单表)
  ├── 1:N payment_logs (支付日志表)
  └── 1:N balance_transactions (余额交易记录表)

domain_orders (域名订单表)
  ├── 1:N payment_logs (支付日志表)
  └── 1:N balance_transactions (余额交易记录表)
```

### 3.2 业务关系说明

1. **一个用户可以有多个套餐订单** (1对多)
   - 用户购买套餐时创建订单
   - 订单包含产品信息快照

2. **一个用户可以有多个域名订单** (1对多)
   - 用户购买域名使用权时创建订单
   - 订单包含域名信息快照

3. **一个用户只能有一个有效订阅** (1对1)
   - 新的订阅会覆盖旧的订阅
   - 订阅记录产品信息和使用情况

4. **一个用户只能有一个余额记录** (1对1)
   - 余额记录当前余额、总充值、总消费

5. **一个用户可以有多个余额交易记录** (1对多)
   - 记录所有余额变动
   - 包括充值、消费、退款等

6. **一个产品套餐可以有多个订单** (1对多)
   - 不同用户可以购买同一个套餐

7. **一个订单可以有多个支付日志** (1对多)
   - 记录每次支付尝试
   - 包括请求、响应、错误信息

8. **一个订单可以关联多个余额交易** (1对多)
   - 余额支付时扣减余额
   - 退款时退回余额

### 3.3 外键约束

- `orders.user_id` → `users.id` (用户删除时订单级联删除)
- `orders.product_id` → `products.id` (产品删除时订单设置为NULL)
- `domain_orders.user_id` → `users.id` (用户删除时订单级联删除)
- `domain_orders.domain_id` → `domains.id` (域名删除时订单设置为NULL)
- `user_subscriptions.user_id` → `users.id` (用户删除时订阅级联删除)
- `user_subscriptions.product_id` → `products.id` (产品删除时订阅设置为NULL)
- `user_balance.user_id` → `users.id` (用户删除时余额级联删除)
- `payment_logs.order_id` → `orders.id` (订单删除时支付日志级联删除)
- `balance_transactions.user_id` → `users.id` (用户删除时交易记录级联删除)
- `balance_transactions.related_order_id` → `orders.id` (订单删除时相关交易设置为NULL)


---

## 4. 索引优化建议

### 4.1 高频查询字段

1. **orders 表**
   - `idx_user_id` - 查询用户订单
   - `idx_status` - 筛选待支付/已支付订单
   - `idx_expires_at` - 查询过期订单(定时任务)

2. **domain_orders 表**
   - `idx_user_id` - 查询用户域名订单
   - `idx_status` - 筛选待支付/已支付订单
   - `idx_expires_at` - 查询过期订单(定时任务)
   - `idx_domain_id` - 查询指定域名的订单

3. **user_subscriptions 表**
   - `idx_user_id` - 查询用户订阅
   - `idx_end_date` - 查询即将到期订阅
   - `idx_is_active` - 筛选激活的订阅

4. **payment_logs 表**
   - `idx_order_id` - 查询订单的支付日志
   - `idx_transaction_id` - 根据第三方交易号查询
   - `idx_created_at` - 按时间范围查询日志

5. **balance_transactions 表**
   - `idx_user_id` - 查询用户交易记录
   - `idx_type` - 筛选交易类型
   - `idx_created_at` - 按时间范围查询


### 4.2 复合索引建议

对于某些查询场景,可以考虑添加复合索引:

```sql
-- 查询用户订单并按状态筛选
CREATE INDEX idx_user_status ON orders(user_id, status);

-- 查询用户域名订单并按状态筛选
CREATE INDEX idx_domain_user_status ON domain_orders(user_id, status);

-- 查询指定域名的订单
CREATE INDEX idx_domain_status ON domain_orders(domain_id, status);

-- 查询用户订阅并按到期时间排序
CREATE INDEX idx_user_end_date ON user_subscriptions(user_id, end_date);

-- 查询用户交易记录并按类型和时间筛选
CREATE INDEX idx_user_type_time ON balance_transactions(user_id, type, created_at);
```


---

## 5. 数据完整性约束

### 5.1 CHECK 约束

```sql
-- 价格不能为负数
ALTER TABLE products ADD CONSTRAINT chk_price_positive CHECK (price >= 0);

-- 原价不能小于价格
ALTER TABLE products ADD CONSTRAINT chk_original_price CHECK (original_price IS NULL OR original_price >= price);

-- 有效期必须大于0
ALTER TABLE products ADD CONSTRAINT chk_duration_days CHECK (duration_days > 0);

-- 最大域名数必须大于等于0
ALTER TABLE products ADD CONSTRAINT chk_max_domains CHECK (max_domains >= 0);

-- 订单金额必须大于0
ALTER TABLE orders ADD CONSTRAINT chk_amount_positive CHECK (final_amount >= 0);

-- 域名订单金额必须大于0
ALTER TABLE domain_orders ADD CONSTRAINT chk_domain_price_positive CHECK (price >= 0);

-- 域名订单有效期必须大于0
ALTER TABLE domain_orders ADD CONSTRAINT chk_domain_duration CHECK (duration_days > 0);

-- 余额不能为负数
ALTER TABLE user_balance ADD CONSTRAINT chk_balance_positive CHECK (balance >= 0);
```


### 5.2 触发器建议

```sql
-- 触发器: 更新订单状态时记录日志
DELIMITER //
CREATE TRIGGER trg_order_status_log
AFTER UPDATE ON orders
FOR EACH ROW
BEGIN
  IF OLD.status != NEW.status THEN
    INSERT INTO payment_logs (order_id, order_no, payment_method, status, amount, created_at)
    VALUES (NEW.id, NEW.order_no, NEW.payment_method, NEW.status, NEW.final_amount, NOW());
  END IF;
END//
DELIMITER ;

-- 触发器: 余额变动时验证余额
DELIMITER //
CREATE TRIGGER trg_balance_validation
BEFORE UPDATE ON user_balance
FOR EACH ROW
BEGIN
  IF NEW.balance < 0 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '余额不能为负数';
  END IF;
END//
DELIMITER ;
```

---

## 6. 初始化SQL脚本

```sql
-- 设置字符集
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- 创建产品套餐表
CREATE TABLE IF NOT EXISTS products (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '产品ID,主键,自增',
  name VARCHAR(100) NOT NULL COMMENT '产品名称',
  description TEXT NULL COMMENT '产品描述',
  price DECIMAL(10,2) NOT NULL COMMENT '产品价格(元)',
  original_price DECIMAL(10,2) NULL COMMENT '原价(用于折扣展示)',
  duration_days INT NOT NULL COMMENT '有效期(天数)',
  max_domains INT NOT NULL COMMENT '最大域名数量',
  max_subdomains INT NOT NULL COMMENT '最大二级域名数量',
  features JSON NULL COMMENT '功能特性(JSON格式)',
  is_active TINYINT(1) DEFAULT 1 COMMENT '是否启用(0:禁用, 1:启用)',
  sort_order INT DEFAULT 0 COMMENT '排序顺序',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_name (name),
  INDEX idx_is_active (is_active),
  INDEX idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='产品套餐表';

-- 创建订单表
CREATE TABLE IF NOT EXISTS orders (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '订单ID,主键,自增',
  order_no VARCHAR(50) NOT NULL UNIQUE COMMENT '订单号',
  user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  product_id BIGINT UNSIGNED NOT NULL COMMENT '产品ID',
  product_name VARCHAR(100) NOT NULL COMMENT '产品名称(快照)',
  price DECIMAL(10,2) NOT NULL COMMENT '订单金额',
  discount_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT '优惠金额',
  final_amount DECIMAL(10,2) NOT NULL COMMENT '实付金额',
  status ENUM('pending', 'paid', 'cancelled', 'expired', 'refunded') DEFAULT 'pending' COMMENT '订单状态',
  payment_method VARCHAR(50) NULL COMMENT '支付方式(alipay, wechat, balance, epay)',
  payment_time TIMESTAMP NULL COMMENT '支付时间',
  paid_at DATETIME NULL COMMENT '支付完成时间',
  transaction_id VARCHAR(100) NULL COMMENT '第三方支付交易号',
  expires_at DATETIME NOT NULL COMMENT '订单过期时间',
  remark TEXT NULL COMMENT '订单备注',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_order_no (order_no),
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  INDEX idx_payment_time (payment_time),
  INDEX idx_expires_at (expires_at),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='订单表';

-- 创建域名订单表
CREATE TABLE IF NOT EXISTS domain_orders (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '订单ID,主键,自增',
  order_no VARCHAR(50) NOT NULL UNIQUE COMMENT '订单号',
  user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  domain_id BIGINT UNSIGNED NOT NULL COMMENT '域名ID',
  domain_name VARCHAR(255) NOT NULL COMMENT '域名(快照)',
  subdomain VARCHAR(100) NULL COMMENT '二级域名(快照)',
  price DECIMAL(10,2) NOT NULL COMMENT '域名价格',
  duration_days INT NOT NULL COMMENT '有效期(天数)',
  status ENUM('pending', 'paid', 'cancelled', 'expired', 'refunded') DEFAULT 'pending' COMMENT '订单状态',
  payment_method VARCHAR(50) NULL COMMENT '支付方式(alipay, wechat, balance, epay)',
  payment_time TIMESTAMP NULL COMMENT '支付时间',
  paid_at DATETIME NULL COMMENT '支付完成时间',
  transaction_id VARCHAR(100) NULL COMMENT '第三方支付交易号',
  expires_at DATETIME NOT NULL COMMENT '订单过期时间',
  remark TEXT NULL COMMENT '订单备注',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_order_no (order_no),
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  INDEX idx_payment_time (payment_time),
  INDEX idx_expires_at (expires_at),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (domain_id) REFERENCES domains(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='域名订单表';

-- 创建用户订阅表
CREATE TABLE IF NOT EXISTS user_subscriptions (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '订阅ID,主键,自增',
  user_id BIGINT UNSIGNED NOT NULL UNIQUE COMMENT '用户ID',
  product_id BIGINT UNSIGNED NOT NULL COMMENT '产品ID',
  product_name VARCHAR(100) NOT NULL COMMENT '产品名称(快照)',
  start_date DATETIME NOT NULL COMMENT '订阅开始时间',
  end_date DATETIME NOT NULL COMMENT '订阅结束时间',
  max_domains INT NOT NULL COMMENT '最大域名数量',
  max_subdomains INT NOT NULL COMMENT '最大二级域名数量',
  used_domains INT DEFAULT 0 COMMENT '已使用域名数量',
  used_subdomains INT DEFAULT 0 COMMENT '已使用二级域名数量',
  features JSON NULL COMMENT '功能特性(JSON格式)',
  is_active TINYINT(1) DEFAULT 1 COMMENT '是否激活',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_user_id (user_id),
  INDEX idx_product_id (product_id),
  INDEX idx_end_date (end_date),
  INDEX idx_is_active (is_active),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户订阅表';

-- 创建支付日志表
CREATE TABLE IF NOT EXISTS payment_logs (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '日志ID,主键,自增',
  order_id BIGINT UNSIGNED NOT NULL COMMENT '订单ID',
  order_no VARCHAR(50) NOT NULL COMMENT '订单号',
  payment_method VARCHAR(50) NOT NULL COMMENT '支付方式',
  transaction_id VARCHAR(100) NULL COMMENT '第三方交易号',
  amount DECIMAL(10,2) NOT NULL COMMENT '支付金额',
  status ENUM('pending', 'success', 'failed', 'refunded') NOT NULL COMMENT '支付状态',
  request_data JSON NULL COMMENT '请求数据',
  response_data JSON NULL COMMENT '响应数据',
  error_message TEXT NULL COMMENT '错误信息',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  INDEX idx_order_id (order_id),
  INDEX idx_order_no (order_no),
  INDEX idx_transaction_id (transaction_id),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='支付日志表';

-- 创建用户余额表
CREATE TABLE IF NOT EXISTS user_balance (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID,主键,自增',
  user_id BIGINT UNSIGNED NOT NULL UNIQUE COMMENT '用户ID',
  balance DECIMAL(10,2) DEFAULT 0.00 COMMENT '当前余额',
  total_recharge DECIMAL(10,2) DEFAULT 0.00 COMMENT '总充值金额',
  total_consumed DECIMAL(10,2) DEFAULT 0.00 COMMENT '总消费金额',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_user_id (user_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户余额表';

-- 创建余额交易记录表
CREATE TABLE IF NOT EXISTS balance_transactions (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '交易ID,主键,自增',
  user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  type ENUM('recharge', 'consume', 'refund', 'withdraw', 'system') NOT NULL COMMENT '交易类型',
  amount DECIMAL(10,2) NOT NULL COMMENT '交易金额(正数表示增加,负数表示减少)',
  balance_before DECIMAL(10,2) NOT NULL COMMENT '交易前余额',
  balance_after DECIMAL(10,2) NOT NULL COMMENT '交易后余额',
  description VARCHAR(255) NULL COMMENT '交易描述',
  related_order_id BIGINT UNSIGNED NULL COMMENT '关联订单ID',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  INDEX idx_user_id (user_id),
  INDEX idx_type (type),
  INDEX idx_related_order_id (related_order_id),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (related_order_id) REFERENCES orders(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='余额交易记录表';

-- 插入初始产品数据
INSERT INTO products (name, description, price, original_price, duration_days, max_domains, max_subdomains, features, is_active, sort_order) VALUES
('免费版', '适合个人用户使用,包含基础功能', 0.00, 0.00, 30, 1, 5, '{"custom_dns": false, "ssl_certificate": false, "api_access": false, "priority_support": false}', 1, 0),
('基础版', '适合小型团队,提供更多功能和资源', 29.90, 59.90, 30, 5, 50, '{"custom_dns": true, "ssl_certificate": false, "api_access": true, "priority_support": false}', 1, 1),
('专业版', '适合企业用户,提供完整功能和优先支持', 99.90, 199.90, 30, 20, 200, '{"custom_dns": true, "ssl_certificate": true, "api_access": true, "priority_support": true}', 1, 2);

SET FOREIGN_KEY_CHECKS = 1;
```

---

## 7. 性能优化建议

### 7.1 查询优化

1. **订单查询优化**
   - 避免使用 `SELECT *`,只查询需要的字段
   - 使用覆盖索引提高查询效率
   - 对大数据量订单表进行分页查询

2. **支付日志清理**
   - 定期清理过期的支付日志(如6个月前)
   - 保留重要日志(如失败的支付)
   - 使用归档表存储历史日志

3. **余额交易归档**
   - 定期将历史交易记录归档
   - 保留近3个月的记录在主表
   - 历史记录移至归档表

### 7.2 分区策略

对于数据量大的表,考虑使用分区:

```sql
-- 按月分区支付日志表
ALTER TABLE payment_logs PARTITION BY RANGE (YEAR(created_at)*100 + MONTH(created_at)) (
  PARTITION p202401 VALUES LESS THAN (202402),
  PARTITION p202402 VALUES LESS THAN (202403),
  PARTITION pmax VALUES LESS THAN MAXVALUE
);

-- 按月分区余额交易表
ALTER TABLE balance_transactions PARTITION BY RANGE (YEAR(created_at)*100 + MONTH(created_at)) (
  PARTITION p202401 VALUES LESS THAN (202402),
  PARTITION p202402 VALUES LESS THAN (202403),
  PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

### 7.3 缓存策略

1. **产品套餐缓存**
   - 使用Redis缓存产品列表
   - 设置合理的过期时间(如5分钟)
   - 产品变更时清除缓存

2. **用户订阅缓存**
   - 缓存用户的当前订阅信息
   - 用于快速验证资源使用权限
   - 订阅更新时清除缓存

---

## 8. 安全考虑

### 8.1 数据安全

1. **敏感数据保护**
   - 支付日志中的敏感信息加密存储
   - 第三方交易号脱敏展示
   - 用户余额操作需要二次验证

2. **金额精度**
   - 使用DECIMAL类型存储金额
   - 避免使用FLOAT类型
   - 所有金额计算使用高精度算法

### 8.2 操作安全

1. **订单操作限制**
   - 防止重复支付订单
   - 订单状态变更需要验证
   - 过期订单自动取消

2. **余额操作限制**
   - 余额不能为负数
   - 余额变动必须有交易记录
   - 重要操作需要日志记录

### 8.3 并发控制

```sql
-- 使用乐观锁防止余额并发更新
UPDATE user_balance 
SET balance = balance - 100,
    updated_at = NOW()
WHERE user_id = 1 AND balance >= 100;

-- 检查影响的行数
-- 如果为0,说明余额不足
```

---

## 9. 维护建议

### 9.1 定期任务

1. **订单过期检查**
   - 每小时检查过期订单
   - 自动取消未支付订单
   - 释放关联资源

2. **订阅到期提醒**
   - 每天检查即将到期的订阅(3天内)
   - 发送邮件提醒用户
   - 记录提醒日志

3. **数据清理**
   - 每周清理过期的支付日志
   - 归档历史交易记录
   - 清理无用的订单数据

### 9.2 监控指标

1. **订单监控**
   - 订单创建量
   - 支付成功率
   - 订单完成时间

2. **支付监控**
   - 支付失败率
   - 支付响应时间
   - 第三方支付错误统计

3. **余额监控**
   - 余额充值量
   - 余额消费量
   - 异常余额变动

---

**文档版本**: V1.0  
**创建日期**: 2024-01-24  
**维护人员**: 开发团队
