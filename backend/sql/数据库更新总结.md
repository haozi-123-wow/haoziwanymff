# 数据库表更新总结

## 更新日期
2026-01-25

## 最新更新

### 0. 域名表优化和二级域名表创建 (2026-01-25)
**状态**: ✅ 已完成

**更新背景**:
将用户购买使用的域名数据从domains表分离，建立更清晰的三层结构：
1. `domains` 表 - 管理员添加的主域名
2. `user_domains` 表 - 用户购买使用的域名
3. `subdomains` 表 - 用户添加的二级域名

#### 0.1 domains 表优化（管理员添加的主域名表）
**变更内容**:
- 添加了 `price` 字段：域名使用价格
- 添加了 `require_icp` 字段：是否需要备案
- 修改了 `remarks` 字段为TEXT类型
- 移除了购买下单相关字段（如果存在）
  - user_id, domain_name, subdomain, target_url
  - duration_days, icp_verified, is_paid, paid_at, expires_at, status

**保留字段**（云平台域名管理）:
  - `id`: 主键ID
  - `platform_id`: 云平台配置ID (关联platform_settings表)
  - `domain`: 完整域名
  - `price`: 域名使用价格
  - `require_icp`: 是否需要备案
  - `is_active`: 是否启用
  - `is_public`: 是否公开(允许用户注册)
  - `remarks`: 备注
  - `created_at`: 创建时间
  - `updated_at`: 更新时间

**索引优化**:
- idx_platform_id: 平台配置ID索引
- idx_is_active: 是否启用索引
- idx_is_public: 是否公开索引

---

#### 0.2 user_domains 表创建（用户购买使用的域名表）
**功能**: 存储用户购买使用的域名信息

**字段**:
- `id`: 主键ID
- `user_id`: 用户ID (外键关联users表, ON DELETE CASCADE)
- `domain_id`: 域名ID (关联domains表, ON DELETE CASCADE)
- `domain_name`: 域名
- `subdomain`: 二级域名
- `full_domain`: 完整域名（二级域名+主域名）
- `target_url`: 目标URL
- `price`: 购买价格
- `duration_days`: 有效期天数
- `icp_verified`: 是否已实名认证
- `is_paid`: 是否已付费
- `paid_at`: 支付时间
- `expires_at`: 到期时间
- `status`: 状态 (active, inactive, banned, pending_payment, pending_icp)
- `remarks`: 备注
- `created_at`: 创建时间
- `updated_at`: 更新时间

**索引**:
- 唯一索引: idx_full_domain (full_domain)
- idx_user_id: 用户ID索引
- idx_domain_id: 域名ID索引
- idx_domain_name: 域名索引
- idx_subdomain: 二级域名索引
- idx_status: 状态索引
- idx_expires_at: 到期时间索引
- idx_is_paid: 是否付费索引

**外键约束**:
- fk_user_domains_user: user_id → users.id (ON DELETE CASCADE)
- fk_user_domains_domain: domain_id → domains.id (ON DELETE CASCADE)

---

#### 0.3 subdomains 表创建（用户二级域名DNS解析记录表）
**功能**: 存储用户为已购买域名配置的DNS解析记录

**业务场景**:
- 用户在 user_domains 表购买了 `blog.example.com` 的使用权
- 用户在 subdomains 表为 `blog.example.com` 添加多条DNS解析记录：
  - A记录: `blog.example.com` → 192.168.1.1（用于网站）
  - CNAME记录: `blog.example.com` → mail.qq.com（用于邮箱）
  - TXT记录: `blog.example.com` → "v=spf1..."（用于邮件验证）

**字段**:
- `id`: 主键ID
- `user_id`: 用户ID (外键关联users表, ON DELETE CASCADE)
- `domain_id`: 对应的域名ID (关联domains表, ON DELETE CASCADE)
- `user_domain_id`: 用户购买域名ID (关联user_domains表, ON DELETE CASCADE) - **重要：直接关联到用户购买的域名**
- `subdomain`: 二级域名
- `full_domain`: 完整域名（二级域名+主域名，如: blog.example.com）
- `record_type`: 解析类型 (A, AAAA, CNAME, MX, TXT, NS, SRV)
- `record_value`: 解析记录
- `description`: 用途说明（这个解析记录是干什么的）
- `status`: 状态 (active, inactive, pending, banned, expired)
- `expires_at`: 到期时间
- `remarks`: 备注
- `created_at`: 创建时间
- `updated_at`: 更新时间

**索引**:
- 唯一索引: idx_full_domain (full_domain)
- idx_user_id: 用户ID索引
- idx_domain_id: 域名ID索引
- idx_user_domain_id: 用户购买域名ID索引 - **重要：用于快速查询某个用户购买域名的所有解析记录**
- idx_subdomain: 二级域名索引
- idx_status: 状态索引
- idx_expires_at: 到期时间索引
- idx_created_at: 创建时间索引

**外键约束**:
- fk_subdomains_user: user_id → users.id (ON DELETE CASCADE)
- fk_subdomains_domain: domain_id → domains.id (ON DELETE CASCADE)
- fk_subdomains_user_domain: user_domain_id → user_domains.id (ON DELETE CASCADE)

---

#### 0.4 表关系说明
```
platform_settings (平台配置表)
  └── 1:N domains (主域名表)

domains (主域名表 - 管理员添加)
  ├── 1:N user_domains (用户购买域名表)
  └── 1:N subdomains (用户二级域名表)

users (用户表)
  ├── 1:N user_domains (用户购买域名表)
  └── 1:N subdomains (用户二级域名表)

user_domains (用户购买域名表)
  └── 1:N subdomains (DNS解析记录表)
```

**业务逻辑**:
1. 管理员在 `platform_settings` 配置云平台信息
2. 管理员在 `domains` 表添加主域名（包含价格、备案要求等）
3. 用户在 `user_domains` 表购买域名使用权（如：blog.example.com）
4. 用户在 `subdomains` 表为购买的域名配置DNS解析记录：
   - 为 blog.example.com 添加 A 记录
   - 为 blog.example.com 添加 CNAME 记录
   - 为 blog.example.com 添加 TXT 记录

**关键区别**:
- **user_domains**: 记录用户**购买**了哪个域名（商业交易，一条记录）
- **subdomains**: 记录为购买的域名配置了哪些DNS解析记录（技术配置，可有多条）

---

#### 0.5 业务示例

**场景**：用户张三要搭建一个博客网站和企业邮箱

**步骤1：管理员添加主域名**
```sql
INSERT INTO domains (
  platform_id, domain, price, require_icp, is_active, is_public
) VALUES (
  1, 'example.com', 30.00, false, true, true
);
```
**含义**：管理员添加了 example.com 主域名，价格30元，不需要备案

---

**步骤2：用户购买域名**
```sql
INSERT INTO user_domains (
  user_id, domain_id, domain_name, subdomain, full_domain,
  target_url, price, duration_days, is_paid, expires_at, status
) VALUES (
  1, 100, 'example.com', 'blog', 'blog.example.com',
  'https://zhangsan-blog.com', 30.00, 30, true, '2026-02-24', 'active'
);
```
**含义**：张三花费30元购买了 blog.example.com 30天的使用权

---

**步骤3：用户配置DNS解析记录**
```sql
-- 为 blog.example.com 添加A记录（网站）
INSERT INTO subdomains (
  user_id, domain_id, user_domain_id, subdomain, full_domain,
  record_type, record_value, description, status
) VALUES (
  1, 100, 1, 'blog', 'blog.example.com',
  'A', '192.168.1.1', '用于官网', 'active'
);

-- 为 blog.example.com 添加CNAME记录（邮箱）
INSERT INTO subdomains (
  user_id, domain_id, user_domain_id, subdomain, full_domain,
  record_type, record_value, description, status
) VALUES (
  1, 100, 1, 'blog', 'blog.example.com',
  'CNAME', 'mail.qq.com', '用于企业邮箱', 'active'
);

-- 为 blog.example.com 添加TXT记录（邮件验证）
INSERT INTO subdomains (
  user_id, domain_id, user_domain_id, subdomain, full_domain,
  record_type, record_value, description, status
) VALUES (
  1, 100, 1, 'blog', 'blog.example.com',
  'TXT', 'v=spf1 include:qq.com ~all', '用于邮件SPF验证', 'active'
);
```
**含义**：张三为购买的 blog.example.com 配置了3条DNS解析记录

---

**结果**：
- user_domains 表中有1条记录：张三购买了 blog.example.com
- subdomains 表中有3条记录：为 blog.example.com 配置了3个DNS解析记录

---

#### 0.6 模型文件更新
**新增模型**:
- `backend/models/UserDomain.js`: 用户购买域名模型
- `backend/models/Subdomain.js`: 用户二级域名DNS解析记录模型

**更新模型**:
- `backend/models/Domain.js`: 简化为只包含管理员添加的域名字段
- `backend/models/index.js`: 添加新模型的导入和关联关系

**关联关系**:
- PlatformSetting ↔ Domain (一对多)
- User ↔ UserDomain (一对多)
- Domain ↔ UserDomain (一对多)
- User ↔ Subdomain (一对多)
- Domain ↔ Subdomain (一对多)
- UserDomain ↔ Subdomain (一对多) - **重要：subdomains 通过 user_domain_id 关联到 user_domains**

---

#### 0.7 SQL脚本文件
所有SQL脚本保存在 `d:/phpstudy_pro/WWW/haoziwanymff/backend/sql/` 目录下：

1. `update_domains_add_subdomains.sql` - 域名表更新和二级域名表创建
2. `migrate_to_user_domains.sql` - 数据迁移脚本（将domains表中购买下单数据迁移到user_domains）

---

## 更新内容

### 1. domains 表更新
**状态**: ✅ 已完成

**变更内容**:
- 备份了原有表数据到 `domains_backup_20260125` (共4条记录)
- 重新创建了domains表，支持新旧业务兼容

**新业务字段（购买下单功能）**:
  - `user_id`: 所属用户ID (外键关联users表)
  - `domain_name`: 域名
  - `subdomain`: 二级域名
  - `target_url`: 目标URL
  - `price`: 域名使用价格
  - `duration_days`: 有效期天数
  - `require_icp`: 是否需要备案
  - `icp_verified`: 是否已实名认证
  - `is_paid`: 是否已付费
  - `paid_at`: 支付时间
  - `expires_at`: 到期时间
  - `status`: 状态 (active, inactive, banned, pending_payment, pending_icp)

**旧业务兼容字段（云平台域名管理）**:
  - `platform_id`: 云平台配置ID (关联platform_settings表)
  - `domain`: 完整域名
  - `is_active`: 是否启用
  - `is_public`: 是否公开
  - `remarks`: 备注

**表结构**:
- 主键: id
- 唯一索引: (domain_name, subdomain), (domain)
- 外键: user_id → users.id (ON DELETE CASCADE)
- 其他索引: idx_user_id, idx_platform_id, idx_domain_name, idx_subdomain, idx_status, idx_expires_at, idx_is_active

**补充更新 (2026-01-25)**:
- 添加了 `platform_id` 字段以兼容原有云平台配置业务
- 添加了 `domain` 字段以兼容旧代码
- 添加了 `is_active`, `is_public`, `remarks` 字段以支持旧业务逻辑
- 添加了相应的索引以优化查询性能

---

### 2. 新建购买下单功能相关表
**状态**: ✅ 已完成

#### 2.1 products 表 (产品套餐表)
**功能**: 存储系统提供的产品套餐信息

**字段**:
- id, name, description, price, original_price
- duration_days, max_domains, max_subdomains
- features (JSON), is_active, sort_order
- created_at, updated_at

**初始数据**: 已插入3个产品
- 免费版 (0元/30天, 1域名, 5二级域名)
- 基础版 (29.9元/30天, 5域名, 50二级域名)
- 专业版 (99.9元/30天, 20域名, 200二级域名)

---

#### 2.2 orders 表 (订单表)
**功能**: 存储用户订单信息

**字段**:
- id, order_no (UNIQUE), user_id, product_id, product_name
- price, discount_amount, final_amount
- status (pending, paid, cancelled, expired, refunded)
- payment_method, payment_time, paid_at, transaction_id
- expires_at, remark
- created_at, updated_at

**外键约束**:
- fk_orders_user: user_id → users.id (ON DELETE CASCADE)
- fk_orders_product: product_id → products.id (ON DELETE CASCADE)

---

#### 2.3 domain_orders 表 (域名订单表)
**功能**: 存储用户购买域名使用权的订单信息

**字段**:
- id, order_no (UNIQUE), user_id, domain_id
- domain_name, subdomain, price, duration_days
- status (pending, paid, cancelled, expired, refunded)
- payment_method, payment_time, paid_at, transaction_id
- expires_at, remark
- created_at, updated_at

**外键约束**:
- fk_domain_orders_user: user_id → users.id (ON DELETE CASCADE)
- fk_domain_orders_domain: domain_id → domains.id (ON DELETE CASCADE)

---

#### 2.4 user_subscriptions 表 (用户订阅表)
**功能**: 存储用户套餐订阅信息

**字段**:
- id, user_id (UNIQUE), product_id, product_name
- start_date, end_date
- max_domains, max_subdomains
- used_domains, used_subdomains
- features (JSON), is_active
- created_at, updated_at

**外键约束**:
- fk_user_subscriptions_user: user_id → users.id (ON DELETE CASCADE)
- fk_user_subscriptions_product: product_id → products.id (ON DELETE CASCADE)

---

#### 2.5 payment_logs 表 (支付日志表)
**功能**: 记录支付相关日志信息

**字段**:
- id, order_id, order_no
- payment_method, transaction_id, amount
- status (pending, success, failed, refunded)
- request_data (JSON), response_data (JSON), error_message
- created_at

**外键约束**:
- fk_payment_logs_order: order_id → orders.id (ON DELETE CASCADE)

---

#### 2.6 user_balance 表 (用户余额表)
**功能**: 存储用户余额信息

**字段**:
- id, user_id (UNIQUE)
- balance, total_recharge, total_consumed
- created_at, updated_at

**外键约束**:
- fk_user_balance_user: user_id → users.id (ON DELETE CASCADE)

---

#### 2.7 balance_transactions 表 (余额交易记录表)
**功能**: 记录用户余额变动流水

**字段**:
- id, user_id, type (recharge, consume, refund, withdraw, system)
- amount, balance_before, balance_after
- description, related_order_id
- created_at

**外键约束**:
- fk_balance_transactions_user: user_id → users.id (ON DELETE CASCADE)
- fk_balance_transactions_order: related_order_id → orders.id (ON DELETE SET NULL)

---

#### 2.8 payment_settings 表 (支付配置表)
**功能**: 存储支付方式的配置信息

**字段**:
- id, payment_method (UNIQUE), payment_name
- config_data (JSON)
- is_enabled, sort_order, description
- created_at, updated_at

**初始数据**: 已插入3种支付方式配置
- alipay (支付宝)
- wechat (微信支付)
- epay (易支付)

---

## 数据库表统计

### 已有表 (10个)
- users
- settings
- captchas
- email_logs
- admin_audit_logs
- admin_session_logs
- audit_failures
- ip_block_audit_logs
- security_event_logs
- platform_settings

### 新建/更新表 (11个)
- domains (已优化 - 管理员添加的主域名表) ✅
- user_domains (新建 - 用户购买使用的域名表) ✅
- subdomains (新建 - 用户添加的二级域名表) ✅
- products ✅
- orders ✅
- domain_orders ✅
- user_subscriptions ✅
- payment_logs ✅
- user_balance ✅
- balance_transactions ✅
- payment_settings ✅

### 备份表 (1个)
- domains_backup_20260125

**总计**: 22个表

---

## SQL脚本文件

所有SQL脚本保存在 `d:/phpstudy_pro/WWW/haoziwanymff/backend/sql/` 目录下：

### 域名和二级域名相关
1. `update_domains_add_subdomains.sql` - 域名表更新和二级域名表创建
2. `migrate_to_user_domains.sql` - 数据迁移脚本（将domains表中购买下单数据迁移到user_domains）

### 购买下单功能相关
3. `update_domains_table.sql` - 更新domains表
4. `step1_create_products.sql` - 创建products表
5. `step2_create_orders_no_fk.sql` - 创建orders表
6. `step3_create_domain_orders.sql` - 创建domain_orders表
7. `step4_create_remaining_tables.sql` - 创建剩余所有表

---

## 注意事项

### 1. 数据备份
- 原有domains表数据已备份到 `domains_backup_20260125`
- 建议在生产环境执行前先进行完整数据库备份

### 2. 外键约束
所有新表都已设置正确的外键约束：
- 级联删除: 用户删除时，相关数据自动删除
- 设置NULL: 产品删除时，订单相关字段设为NULL

### 3. 索引优化
- 已为所有高频查询字段创建索引
- 复合索引可根据实际查询情况进一步优化

### 4. 数据迁移
- domains表的原有数据已备份，新表需要根据业务逻辑重新填充
- 建议根据实际业务需求编写数据迁移脚本

---

## 下一步建议

1. **开发API接口**
   - 产品套餐管理API
   - 订单管理API
   - 支付处理API
   - 余额管理API

2. **集成支付功能**
   - 配置支付宝支付
   - 配置微信支付
   - 配置易支付

3. **开发业务逻辑**
   - 订单创建流程
   - 支付回调处理
   - 订单状态管理
   - 余额扣减逻辑

4. **测试验证**
   - 单元测试
   - 集成测试
   - 支付流程测试

---

**更新人员**: AI Assistant
**审核状态**: 待审核
**生产环境部署**: 待部署
