# 二级域名分发系统数据库表结构设计

## 1. 概述

本系统使用 MySQL 5.7+ 作为主数据库，采用合理的表结构设计来支持用户管理、网站设置、验证令牌等功能。

## 2. 数据库表结构

### 2.1 users 表 (用户表)

存储系统用户的基本信息。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 用户ID，主键，自增 |
| username | VARCHAR(50) | NOT NULL, UNIQUE | 用户名 |
| email | VARCHAR(100) | NOT NULL, UNIQUE | 邮箱 |
| password | VARCHAR(255) | NOT NULL | 加密密码 |
| is_active | TINYINT(1) | DEFAULT 0 | 是否激活 (0:未激活, 1:已激活) |
| is_banned | TINYINT(1) | DEFAULT 0 | 是否封禁 (0:未封禁, 1:已封禁) |
| ban_reason | TEXT | NULL | 封禁原因 |
| activation_token | VARCHAR(255) | NULL | 激活令牌 |
| activation_token_expires | DATETIME | NULL | 激活令牌过期时间 |
| role | ENUM('user', 'admin') | DEFAULT 'user' | 用户角色 (user:普通用户, admin:管理员) |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

索引：
- idx_email: email
- idx_username: username
- idx_activation_token: activation_token
- idx_is_banned: is_banned

### 2.2 settings 表 (系统设置表)

存储网站配置信息。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 设置ID，主键，自增 |
| key | VARCHAR(100) | NOT NULL, UNIQUE | 设置键名 |
| value | TEXT | NOT NULL | 设置值(JSON格式) |
| description | VARCHAR(255) | NULL | 设置描述 |
| type | ENUM('general', 'email', 'geetest', 'other') | DEFAULT 'general' | 设置类型 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

索引：
- idx_key: key
- idx_type: type

### 2.3 captchas 表 (验证令牌表)

存储极验验证等临时令牌信息。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 令牌ID，主键，自增 |
| token | VARCHAR(255) | NOT NULL, UNIQUE | 验证令牌 |
| user_id | BIGINT UNSIGNED | NULL | 关联用户ID |
| expires_at | DATETIME | NOT NULL | 过期时间 |
| used | TINYINT(1) | DEFAULT 0 | 是否已使用 (0:未使用, 1:已使用) |
| type | VARCHAR(50) | DEFAULT 'geetest' | 令牌类型 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

索引：
- idx_token: token
- idx_user_id: user_id
- idx_expires_at: expires_at
- idx_used: used

### 2.4 domains 表 (域名表)

存储系统管理的域名信息。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 域名ID，主键，自增 |
| user_id | BIGINT UNSIGNED | NOT NULL | 所属用户ID |
| domain_name | VARCHAR(255) | NOT NULL | 域名 |
| subdomain | VARCHAR(100) | NOT NULL | 二级域名 |
| target_url | TEXT | NOT NULL | 目标URL |
| status | ENUM('active', 'inactive', 'banned') | DEFAULT 'active' | 状态 (active:启用, inactive:禁用, banned:封禁) |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

索引：
- idx_user_id: user_id
- idx_domain_name: domain_name
- idx_subdomain: subdomain
- idx_status: status
- idx_domain_subdomain: (domain_name, subdomain) - 唯一索引

### 2.5 email_logs 表 (邮件日志表)

记录系统发送的邮件信息。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 日志ID，主键，自增 |
| user_id | BIGINT UNSIGNED | NULL | 关联用户ID |
| recipient | VARCHAR(255) | NOT NULL | 收件人邮箱 |
| subject | VARCHAR(255) | NOT NULL | 邮件主题 |
| content | TEXT | NULL | 邮件内容 |
| status | ENUM('sent', 'failed', 'pending') | DEFAULT 'pending' | 发送状态 (sent:已发送, failed:发送失败, pending:待发送) |
| error_message | TEXT | NULL | 错误信息 |
| sent_at | TIMESTAMP | NULL | 发送时间 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

索引：
- idx_user_id: user_id
- idx_recipient: recipient
- idx_status: status
- idx_sent_at: sent_at

### 2.6 payment_settings 表 (支付配置表)

存储支付方式的配置信息，包括支付宝、微信支付、易支付等。

| 字段名 | 类型 | 约束 | 注释 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 配置ID，主键，自增 |
| payment_method | VARCHAR(50) | NOT NULL, UNIQUE | 支付方式 (alipay/wechat/epay) |
| payment_name | VARCHAR(100) | NOT NULL | 支付方式名称 |
| config_data | JSON | NOT NULL | 配置数据(JSON格式，加密存储) |
| is_enabled | TINYINT(1) | DEFAULT 0 | 是否启用 (0:未启用, 1:已启用) |
| sort_order | INT | DEFAULT 0 | 排序顺序 |
| description | TEXT | NULL | 配置描述 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

索引：
- idx_payment_method: payment_method
- idx_is_enabled: is_enabled

**config_data 字段结构说明**:

**支付宝配置 (alipay)**:
```json
{
  "appId": "2021xxxxxxxx",
  "privateKey": "-----BEGIN RSA PRIVATE KEY-----\n...\n-----END RSA PRIVATE KEY-----",
  "alipayPublicKey": "-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----",
  "gatewayUrl": "https://openapi.alipay.com/gateway.do",
  "notifyUrl": "https://yourdomain.com/api/v1/payments/callback/alipay",
  "returnUrl": "https://yourdomain.com/payment/return"
}
```

**微信支付配置 (wechat)**:
```json
{
  "appId": "wx1234567890abcdef",
  "mchId": "1234567890",
  "apiKey": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "certPath": "/path/to/apiclient_cert.pem",
  "keyPath": "/path/to/apiclient_key.pem",
  "notifyUrl": "https://yourdomain.com/api/v1/payments/callback/wechat"
}
```

**易支付配置 (epay)**:
```json
{
  "pid": "1000",
  "key": "your_epay_key",
  "apiUrl": "https://epay.example.com",
  "notifyUrl": "https://yourdomain.com/api/v1/payments/callback/epay",
  "returnUrl": "https://yourdomain.com/payment/return"
}
```

## 3. 表关系

### 3.1 外键关系
- `settings.user_id` → `users.id` (可选关联)
- `captchas.user_id` → `users.id` (可选关联)
- `domains.user_id` → `users.id` (必需关联)
- `email_logs.user_id` → `users.id` (可选关联)

### 3.2 业务关系说明
1. 一个用户可以拥有多个域名 (1对多)
2. 一个用户可以有多条邮件日志 (1对多)
3. 一个用户可以有多个验证令牌 (1对多)
4. 系统设置独立存在，部分与用户关联
5. 支付配置独立存在，系统支持多种支付方式(支付宝、微信、易支付)

## 4. 数据库初始化脚本

```sql
-- 设置字符集
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- 创建用户表
CREATE TABLE IF NOT EXISTS users (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID，主键，自增',
  username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
  email VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱',
  password VARCHAR(255) NOT NULL COMMENT '加密密码',
  is_active TINYINT(1) DEFAULT 0 COMMENT '是否激活 (0:未激活, 1:已激活)',
  activation_token VARCHAR(255) NULL COMMENT '激活令牌',
  activation_token_expires DATETIME NULL COMMENT '激活令牌过期时间',
  role ENUM('user', 'admin') DEFAULT 'user' COMMENT '用户角色 (user:普通用户, admin:管理员)',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_email (email),
  INDEX idx_username (username),
  INDEX idx_activation_token (activation_token)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';

-- 创建设置表
CREATE TABLE IF NOT EXISTS settings (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '设置ID，主键，自增',
  `key` VARCHAR(100) NOT NULL UNIQUE COMMENT '设置键名',
  value TEXT NOT NULL COMMENT '设置值(JSON格式)',
  description VARCHAR(255) NULL COMMENT '设置描述',
  type ENUM('general', 'email', 'geetest', 'other') DEFAULT 'general' COMMENT '设置类型',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_key (`key`),
  INDEX idx_type (type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统设置表';

-- 创建验证令牌表
CREATE TABLE IF NOT EXISTS captchas (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '令牌ID，主键，自增',
  token VARCHAR(255) NOT NULL UNIQUE COMMENT '验证令牌',
  user_id BIGINT UNSIGNED NULL COMMENT '关联用户ID',
  expires_at DATETIME NOT NULL COMMENT '过期时间',
  used TINYINT(1) DEFAULT 0 COMMENT '是否已使用 (0:未使用, 1:已使用)',
  type VARCHAR(50) DEFAULT 'geetest' COMMENT '令牌类型',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_token (token),
  INDEX idx_user_id (user_id),
  INDEX idx_expires_at (expires_at),
  INDEX idx_used (used)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='验证令牌表';

-- 创建域名表
CREATE TABLE IF NOT EXISTS domains (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '域名ID，主键，自增',
  user_id BIGINT UNSIGNED NOT NULL COMMENT '所属用户ID',
  domain_name VARCHAR(255) NOT NULL COMMENT '域名',
  subdomain VARCHAR(100) NOT NULL COMMENT '二级域名',
  target_url TEXT NOT NULL COMMENT '目标URL',
  status ENUM('active', 'inactive', 'banned') DEFAULT 'active' COMMENT '状态 (active:启用, inactive:禁用, banned:封禁)',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_user_id (user_id),
  INDEX idx_domain_name (domain_name),
  INDEX idx_subdomain (subdomain),
  INDEX idx_status (status),
  UNIQUE INDEX idx_domain_subdomain (domain_name, subdomain),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='域名表';

-- 创建邮件日志表
CREATE TABLE IF NOT EXISTS email_logs (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '日志ID，主键，自增',
  user_id BIGINT UNSIGNED NULL COMMENT '关联用户ID',
  recipient VARCHAR(255) NOT NULL COMMENT '收件人邮箱',
  subject VARCHAR(255) NOT NULL COMMENT '邮件主题',
  content TEXT NULL COMMENT '邮件内容',
  status ENUM('sent', 'failed', 'pending') DEFAULT 'pending' COMMENT '发送状态 (sent:已发送, failed:发送失败, pending:待发送)',
  error_message TEXT NULL COMMENT '错误信息',
  sent_at TIMESTAMP NULL COMMENT '发送时间',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  INDEX idx_user_id (user_id),
  INDEX idx_recipient (recipient),
  INDEX idx_status (status),
  INDEX idx_sent_at (sent_at),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='邮件日志表';

-- 创建支付配置表
CREATE TABLE IF NOT EXISTS payment_settings (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '配置ID，主键，自增',
  payment_method VARCHAR(50) NOT NULL UNIQUE COMMENT '支付方式(alipay/wechat/epay)',
  payment_name VARCHAR(100) NOT NULL COMMENT '支付方式名称',
  config_data JSON NOT NULL COMMENT '配置数据(JSON格式)',
  is_enabled TINYINT(1) DEFAULT 0 COMMENT '是否启用(0:未启用, 1:已启用)',
  sort_order INT DEFAULT 0 COMMENT '排序顺序',
  description TEXT NULL COMMENT '配置描述',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_payment_method (payment_method),
  INDEX idx_is_enabled (is_enabled)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='支付配置表';

-- 插入初始支付配置(需要后续在后台更新实际配置)
INSERT INTO payment_settings (payment_method, payment_name, config_data, is_enabled, sort_order, description) VALUES
('alipay', '支付宝', 
 '{"appId":"","privateKey":"","alipayPublicKey":"","gatewayUrl":"https://openapi.alipay.com/gateway.do","notifyUrl":"https://yourdomain.com/api/v1/payments/callback/alipay","returnUrl":"https://yourdomain.com/payment/return"}',
 0, 1, '支付宝支付配置'),
('wechat', '微信支付', 
 '{"appId":"","mchId":"","apiKey":"","certPath":"","keyPath":"","notifyUrl":"https://yourdomain.com/api/v1/payments/callback/wechat"}',
 0, 2, '微信支付配置'),
('epay', '易支付', 
 '{"pid":"","key":"","apiUrl":"https://epay.example.com","notifyUrl":"https://yourdomain.com/api/v1/payments/callback/epay","returnUrl":"https://yourdomain.com/payment/return"}',
 0, 3, '易支付聚合支付配置(支持支付宝/微信/QQ支付)');

-- 插入初始系统设置
INSERT INTO settings (`key`, value, description, type) VALUES
('siteTitle', 'Haoziwanymff 管理系统', '网站标题', 'general'),
('siteDescription', '一个功能强大的二级域名分发系统', '网站描述', 'general'),
('registerConfig', '{"allowRegister": true, "needActivation": true, "needCaptcha": true}', '注册配置', 'general');

SET FOREIGN_KEY_CHECKS = 1;
```

## 5. 性能优化建议

1. 为经常查询的字段建立索引
2. 定期清理过期的验证令牌和邮件日志
3. 使用连接池管理数据库连接
4. 对于大量数据的表，考虑分区策略
5. 定期分析和优化查询语句

## 6. 安全考虑

1. 敏感数据如密码必须加密存储
2. 验证令牌有过期时间限制
3. 防止SQL注入，使用参数化查询
4. 用户输入数据需进行验证和清理
5. 访问控制和权限验证