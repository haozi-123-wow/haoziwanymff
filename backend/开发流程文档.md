# 二级域名分发系统后端开发流程文档

## 1. 项目概述

本项目是一个基于 Node.js、MySQL、Redis 的二级域名分发系统，采用 Express 框架和 Sequelize ORM。系统包含用户认证、极验人机验证、管理员功能等模块。

## 2. 环境准备

### 2.1 技术栈
- Node.js (版本 ≥ 20.19.0)
- pnpm (版本 ≥ 10.5.0)
- MySQL (版本 ≥ 8.0)
- Redis (版本 ≥ 6.0)
- Express.js
- Sequelize ORM
- Redis 客户端

### 2.2 依赖安装
```bash
# 安装 pnpm（如果尚未安装）
npm install -g pnpm

# 安装项目依赖
cd backend
pnpm install
```

### 2.3 环境配置
创建 `.env` 文件并配置以下环境变量：

```
# 服务器配置
PORT=3000

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your-mysql-password
DB_NAME=haoziwanymff

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT配置
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRES_IN=7d

# 邮件服务配置 (以Gmail为例)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password

# 极验验证配置
GEETEST_CAPTCHA_ID=647f5ed2ed8acb4be36784e01556bb71
GEETEST_CAPTCHA_KEY=b09a7aafbfd83f73b35a9b530d0337bf
GEETEST_API_SERVER=http://gcaptcha4.geetest.com

# 激活链接配置
ACTIVATION_LINK_EXPIRES_HOURS=24
FRONTEND_URL=http://localhost:5173
```

## 3. 数据库设计

### 3.1 数据库初始化
```bash
# 启动 MySQL 服务
# 确保 MySQL 服务已启动并运行

# 创建数据库
mysql -u root -p
CREATE DATABASE haoziwanymff;
```

### 3.2 数据库模型
系统包含以下主要模型：

#### User 模型
- id: BIGINT (主键，自增)
- username: STRING (唯一，长度3-20)
- email: STRING (唯一，邮箱格式)
- password: STRING (加密存储)
- isActive: BOOLEAN (默认false)
- activationToken: STRING (激活令牌)
- activationTokenExpires: DATE (激活令牌过期时间)
- role: STRING (默认'user'，可选值'user', 'admin')

#### Setting 模型
- id: BIGINT (主键，自增)
- key: STRING (唯一)
- value: TEXT (JSON格式)
- description: STRING

#### Captcha 模型
- id: BIGINT (主键，自增)
- token: STRING (唯一)
- userId: BIGINT (关联用户)
- expiresAt: DATE (过期时间)
- used: BOOLEAN (默认false)
- type: STRING (默认'geetest')

## 4. 项目结构

```
backend/
├── config/
│   ├── db.js          # 数据库配置
│   └── redis.js       # Redis配置
├── controllers/
│   ├── authController.js    # 认证控制器
│   ├── captchaController.js # 极验验证控制器
│   └── adminController.js   # 管理员控制器
├── middleware/
│   └── auth.js        # 认证中间件
├── models/
│   ├── User.js        # 用户模型
│   ├── Setting.js     # 设置模型
│   ├── Captcha.js     # 验证码模型
│   └── index.js       # 模型入口
├── routes/
│   ├── index.js       # 路由入口
│   ├── auth.js        # 认证路由
│   ├── captcha.js     # 验证码路由
│   ├── user.js        # 用户路由
│   └── admin.js       # 管理员路由
├── utils/
│   ├── geetestService.js  # 极验验证服务
│   └── emailService.js    # 邮件服务
├── .env               # 环境变量配置
├── package.json       # 项目配置
├── server.js          # 主服务器文件
└── README.md          # 项目说明
```

## 5. 开发流程

### 5.1 启动项目
```bash
# 开发模式启动
pnpm run dev

# 生产模式启动
pnpm start
```

### 5.2 API 开发规范

#### 5.2.1 路由规范
- 所有 API 路径以 `/api/v1` 开头
- 使用 RESTful 风格设计路由
- 路径参数使用 `:paramName` 格式

#### 5.2.2 响应格式
所有响应遵循统一结构：

```json
{
  "code": 0,
  "message": "success",
  "data": {},
  "timestamp": 1698765432000
}
```

#### 5.2.3 状态码规范
- `0`: Success
- `1001`: 参数错误
- `1002`: 未授权
- `1003`: Token 过期或无效
- `1004`: 资源已存在
- `1005`: 资源不存在
- `5000`: 服务器内部错误

### 5.3 控制器开发

#### 5.3.1 认证控制器 (authController.js)
实现用户注册、激活、登录、登出、获取用户信息、邮箱验证码登录等功能：

```javascript
// 示例：用户注册
const register = async (req, res) => {
  try {
    const { username, email, password, validate_token } = req.body;

    // 验证人机验证令牌
    const isValidCaptcha = await verifyValidateToken(validate_token);
    if (!isValidCaptcha) {
      return res.status(400).json({
        code: 1002,
        message: '人机验证未通过，请重新验证',
        data: null,
        timestamp: Date.now()
      });
    }

    // ... 其他逻辑
  } catch (error) {
    // 错误处理
  }
};

// 示例：邮箱验证码登录
const loginWithEmailCode = async (req, res) => {
  try {
    const { email, code, validate_token } = req.body;

    // 验证人机验证令牌
    const isValidCaptcha = await verifyValidateToken(validate_token);
    if (!isValidCaptcha) {
      return res.status(400).json({
        code: 1002,
        message: '人机验证未通过，请重新验证',
        data: null,
        timestamp: Date.now()
      });
    }

    // 验证验证码
    const isValidCode = await verifyEmailCode(email, code);
    if (!isValidCode) {
      return res.status(400).json({
        code: 1001,
        message: '验证码错误或已过期',
        data: null,
        timestamp: Date.now()
      });
    }

    // 查找用户
    const user = await User.findOne({ where: { email } });
    if (!user) {
      return res.status(404).json({
        code: 1005,
        message: '用户不存在',
        data: null,
        timestamp: Date.now()
      });
    }

    // 生成JWT令牌
    const token = jwt.sign(
      { userId: user.id, email: user.email, role: user.role },
      process.env.JWT_SECRET,
      { expiresIn: process.env.JWT_EXPIRES_IN }
    );

    // 返回登录令牌
    res.json({
      code: 0,
      message: '登录成功',
      data: { token },
      timestamp: Date.now()
    });
  } catch (error) {
    // 错误处理
  }
};
```
```

#### 5.3.2 极验验证控制器 (captchaController.js)
实现获取配置和验证功能：

```javascript
// 示例：极验二次验证
const validateCaptcha = async (req, res) => {
  try {
    const { lot_number, captcha_output, pass_token, gen_time } = req.body;

    const result = await validateGeetest({
      lot_number,
      captcha_output,
      pass_token,
      gen_time
    });

    // 返回验证结果
  } catch (error) {
    // 错误处理
  }
};
```

#### 5.3.3 管理员控制器 (adminController.js)
实现网站设置、用户管理等功能：

```javascript
// 示例：获取网站设置
const getSettings = async (req, res) => {
  try {
    // 获取所有设置项
    const settings = await Setting.findAll();
    // ... 处理设置项
  } catch (error) {
    // 错误处理
  }
};
```

### 5.4 中间件开发

#### 5.4.1 认证中间件
- JWT 令牌验证
- 用户权限检查
- 管理员权限验证

```javascript
const authenticateToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN

  if (!token) {
    return res.status(401).json({
      code: 1002,
      message: '未提供访问令牌',
      data: null,
      timestamp: Date.now()
    });
  }

  jwt.verify(token, process.env.JWT_SECRET, async (err, decoded) => {
    // 验证逻辑
  });
};
```

### 5.5 服务模块开发

#### 5.5.1 极验验证服务 (geetestService.js)
- 验证极验参数
- 生成内部验证令牌
- 验证内部令牌

#### 5.5.2 邮件服务 (emailService.js)
- 发送HTML格式激活邮件
- 发送测试邮件
- 发送验证码邮件

### 5.6 API 接口文档

#### 5.6.1 认证相关接口

##### 用户注册
- **接口地址**: `POST /api/v1/auth/register`
- **请求参数**:
  ```json
  {
    "username": "string",
    "email": "string",
    "password": "string",
    "validate_token": "string"
  }
  ```
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "注册成功，请查收激活邮件",
    "data": null,
    "timestamp": 1698765432000
  }
  ```

##### 邮箱密码登录
- **接口地址**: `POST /api/v1/auth/login`
- **请求参数**:
  ```json
  {
    "email": "string",
    "password": "string",
    "validate_token": "string"
  }
  ```
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "登录成功",
    "data": {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    },
    "timestamp": 1698765432000
  }
  ```

##### 邮箱验证码登录
- **接口地址**: `POST /api/v1/auth/login-with-code`
- **请求参数**:
  ```json
  {
    "email": "string",
    "code": "string",
    "validate_token": "string"
  }
  ```
- **参数说明**:
  - `email`: 用户邮箱地址
  - `code`: 邮箱验证码（6位数字）
  - `validate_token`: 极验人机验证令牌
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "登录成功",
    "data": {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    },
    "timestamp": 1698765432000
  }
  ```
- **错误响应示例**:
  ```json
  {
    "code": 1001,
    "message": "验证码错误或已过期",
    "data": null,
    "timestamp": 1698765432000
  }
  ```

##### 发送验证码
- **接口地址**: `POST /api/v1/auth/send-code`
- **请求参数**:
  ```json
  {
    "email": "string",
    "validate_token": "string"
  }
  ```
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "验证码已发送",
    "data": null,
    "timestamp": 1698765432000
  }
  ```

##### 获取用户信息
- **接口地址**: `GET /api/v1/auth/me`
- **请求头**: `Authorization: Bearer {token}`
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "success",
    "data": {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "role": "admin",
      "isActive": true
    },
    "timestamp": 1698765432000
  }
  ```

##### 用户登出
- **接口地址**: `POST /api/v1/auth/logout`
- **请求头**: `Authorization: Bearer {token}`
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "登出成功",
    "data": null,
    "timestamp": 1698765432000
  }
  ```

#### 5.6.2 极验验证接口

##### 获取极验配置
- **接口地址**: `GET /api/v1/captcha/config`
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "success",
    "data": {
      "captchaId": "647f5ed2ed8acb4be36784e01556bb71",
      "apiServer": "http://gcaptcha4.geetest.com",
      "timestamp": 1698765432000
    },
    "timestamp": 1698765432000
  }
  ```

##### 极验二次验证
- **接口地址**: `POST /api/v1/captcha/validate`
- **请求参数**:
  ```json
  {
    "lot_number": "string",
    "captcha_output": "string",
    "pass_token": "string",
    "gen_time": "string"
  }
  ```
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "验证成功",
    "data": {
      "validate_token": "string"
    },
    "timestamp": 1698765432000
  }
  ```

#### 5.6.3 管理员接口

##### 获取网站设置
- **接口地址**: `GET /api/v1/admin/settings`
- **请求头**: `Authorization: Bearer {token}`
- **权限要求**: admin
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "success",
    "data": {
      "siteName": "二级域名分发系统",
      "siteDescription": "一个强大的二级域名分发系统"
    },
    "timestamp": 1698765432000
  }
  ```

##### 更新网站设置
- **接口地址**: `PUT /api/v1/admin/settings`
- **请求头**: `Authorization: Bearer {token}`
- **权限要求**: admin
- **请求参数**:
  ```json
  {
    "key": "string",
    "value": "string",
    "description": "string"
  }
  ```
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "设置更新成功",
    "data": null,
    "timestamp": 1698765432000
  }
  ```

## 6. 安全措施

### 6.1 人机验证
所有敏感操作（注册、登录、发送邮件等）都需要通过极验人机验证。

### 6.2 JWT 认证
使用 JWT 实现用户认证，令牌过期时间可配置。

### 6.3 密码加密
用户密码使用 bcrypt 加密存储。

### 6.4 速率限制
使用 express-rate-limit 限制API请求频率。

### 6.5 安全头
使用 helmet 中间件增强安全性。

## 7. 数据库操作

### 7.1 Sequelize ORM 使用
```javascript
// 查询用户
const user = await User.findByPk(id);

// 创建用户
const newUser = await User.create({
  username: 'example',
  email: 'example@example.com',
  password: 'password'
});

// 更新用户
await user.update({ isActive: true });
```

### 7.2 关联关系
- User 与 Setting 之间没有直接关联
- Captcha 可关联到特定用户

## 8. Redis 使用

### 8.1 Redis 客户端
- 用于缓存常用数据
- 存储会话信息
- 临时存储验证令牌

## 9. 测试流程

### 9.1 单元测试
```bash
# 运行单元测试
pnpm test
```

### 9.2 集成测试
- 测试 API 接口
- 验证数据流程
- 检查安全措施

## 10. 部署流程

### 10.1 生产环境部署
1. 确保服务器已安装 Node.js 和 pnpm
2. 配置生产环境的 `.env` 文件
3. 安装依赖：`pnpm install --production`
4. 启动服务：`pnpm start`

### 10.2 Docker 部署（可选）
```dockerfile
FROM node:20-alpine

WORKDIR /app
COPY package*.json ./
RUN pnpm install --production

COPY . .

EXPOSE 3000
CMD ["pnpm", "start"]
```

## 11. 维护和监控

### 11.1 日志记录
- 记录错误日志
- 记录API访问日志
- 记录安全事件

### 11.2 性能监控
- 监控数据库连接
- 监控内存使用
- 监控API响应时间

## 12. 常见问题

### 12.1 数据库连接问题
- 检查数据库服务是否运行
- 验证连接参数是否正确
- 确认数据库用户权限

### 12.2 Redis 连接问题
- 检查 Redis 服务是否运行
- 验证连接参数是否正确

### 12.3 极验验证问题
- 确认极验配置参数正确
- 检查网络连接是否正常
- 验证 API 密钥是否有效